{% extends "base.html" %}
{% block content %}

<section class="form-section">
    <h2>Добавить задачу</h2>
    <form method="post" action="/add" class="task-form">
        <label>
            Дата
            <input type="date" name="date" required value="{{ today }}">
        </label>

        <label>
            Difficulty
            <select name="difficulty">
                <option value="Easy">Easy</option>
                <option value="Medium">Medium</option>
                <option value="Hard">Hard</option>
            </select>
        </label>

        <label>
            XP
            <input type="number" name="points" value="1" min="1" required>
        </label>

        <label>
            ID задачи
            <input type="text" name="problem_id" placeholder="например 209">
        </label>

        <label>
            Название
            <input type="text" name="title" placeholder="Optional">
        </label>

        <label class="fullwidth">
            Комментарий
            <textarea name="notes" rows="2" placeholder="что было сложным, что выучил?"></textarea>
        </label>

        <button type="submit">Сохранить</button>
    </form>
</section>

<section class="charts">
    <h2>Графики продуктивности</h2>
    <div class="chart-grid">
        <div class="chart-card">
            <h3>Задачи в день</h3>
            <canvas id="tasksPerDay"></canvas>
        </div>
        <div class="chart-card">
            <h3>XP в день</h3>
            <canvas id="xpPerDay"></canvas>
        </div>
        <div class="chart-card">
            <h3>Кумулятивный XP</h3>
            <canvas id="xpCumulative"></canvas>
        </div>
        <div class="chart-card">
            <h3>Streak</h3>
            <canvas id="streakChart"></canvas>
        </div>
    </div>
</section>

<section class="table-section">
    <h2>Последние задачи</h2>
    <table>
        <thead>
            <tr>
                <th>Дата</th>
                <th>ID</th>
                <th>Название</th>
                <th>Diff</th>
                <th>XP</th>
                <th>Комментарий</th>
            </tr>
        </thead>
        <tbody>
            {% for t in tasks %}
            <tr>
                <td>{{ t.date }}</td>
                <td>{{ t.problem_id or "" }}</td>
                <td>{{ t.title or "" }}</td>
                <td>{{ t.difficulty }}</td>
                <td>{{ t.points }}</td>
                <td>{{ t.notes or "" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<script>
async function loadStats() {
    const res = await fetch('/api/stats/daily');
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
        return;
    }

    const labels = data.map(d => d.date);
    const tasks = data.map(d => d.tasks_count);
    const xp = data.map(d => d.xp_sum);
    const xpCum = data.map(d => d.xp_cumulative);
    const streak = data.map(d => d.streak);

    const makeChart = (id, type, label, values) => {
        const ctx = document.getElementById(id);
        new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: values,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
            }
        });
    };

    makeChart('tasksPerDay', 'bar', 'Задач', tasks);
    makeChart('xpPerDay', 'bar', 'XP', xp);
    makeChart('xpCumulative', 'line', 'XP (кумулятивно)', xpCum);
    makeChart('streakChart', 'line', 'Streak', streak);
}

loadStats();
</script>

{% endblock %}

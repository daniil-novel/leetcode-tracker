# План улучшения архитектуры и исправления сессий LeetCode Tracker

На основе анализа текущего кода и конфигурации сервера выявлены основные причины проблем с авторизацией ("вылеты" на страницу входа) и недостатки архитектуры.

## 1. Исправление проблем с сессиями и авторизацией (Приоритет: Высокий)
**Проблема:** FastAPI не знает, что работает за HTTPS-прокси, поэтому считает соединение незащищенным (HTTP). Это приводит к проблемам с `Secure` cookies и формированием ссылок redirect_uri. Пользователь "вылетает", потому что cookie либо не устанавливается, либо браузер не отправляет его, либо приложение отклоняет его.

**Решение:**
- [ ] **Настройка Proxy Headers:** Добавить аргумент `--proxy-headers` в команду запуска Uvicorn в `systemd` сервисе. Это скажет FastAPI доверять заголовкам от Nginx (`X-Forwarded-Proto: https`).
- [ ] **Middleware TrustHost:** Добавить `TrustedHostMiddleware` или явно настроить `ProxyHeadersMiddleware` для безопасности.
- [ ] **Обработка 401 Unauthorized:** Реализовать глобальный обработчик ошибок или middleware, который автоматически перенаправляет пользователя на `/login` при истечении сессии, вместо показа JSON ошибки или "пустой" страницы.
- [ ] **Оптимизация Cookies:**
    - Убедиться, что `Path=/` установлен явно.
    - Проверить совместимость `SameSite=Lax` с POST-запросами при навигации.
- [ ] **Безопасный выход:** Реализовать корректное удаление cookies при логауте.

## 2. Рефакторинг Архитектуры (Modularity)
**Проблема:** Файл `main.py` перегружен. В нем смешаны конфигурация, модели, маршруты страниц, API, и логика БД.

**Решение:**
- [ ] **Структура проекта:** Разделить приложение на модули:
    ```
    leetcode_tracker/
    ├── main.py            # Инициализация app, middleware, exception handlers
    ├── config.py          # Настройки и переменные окружения (Pydantic Settings)
    ├── database.py        # Подключение к БД
    ├── dependencies.py    # Общие зависимости (get_db, get_current_user)
    ├── routers/           # Маршруты
    │   ├── auth.py        # Логин, OAuth
    │   ├── frontend.py    # HTML страницы (Index, Profile)
    │   ├── api_tasks.py   # API для задач
    │   └── api_stats.py   # API для статистики
    ├── models.py          # SQLAlchemy модели
    └── schemas.py         # Pydantic схемы (валидация)
    ```
- [ ] **Централизация конфигурации:** Перенести загрузку `.env` и секретов в `config.py`.

## 3. Улучшение работы кнопок и форм
**Проблема:** Формы отправляют POST запросы и ожидают редиректа. Если токен истек, пользователь видит ошибку.

**Решение:**
- [ ] **AJAX/Fetch вместо форм:** Перевести добавление задач на `fetch` запросы (как уже сделано для удаления/редактирования). Это позволит ловить ошибку 401 и показывать красивое окно "Войдите снова" или автоматически перенаправлять, не перезагружая страницу с потерей данных.
- [ ] **CSRF защита:** (Опционально, но рекомендуется) Добавить защиту от CSRF атак.

## 4. База Данных и Пользователи
**Проблема:** Пользователи уже сохраняются в БД, но механизм миграций отсутствует. При изменении моделей приходится пересоздавать БД вручную.

**Решение:**
- [ ] **Alembic Migrations:** Настроить Alembic для автоматических миграций БД. Это позволит менять структуру таблиц без потери данных.
- [ ] **User Model:** Убедиться, что `oauth_id` и `email` индексированы (уже сделано). Добавить поле `is_active` для блокировки пользователей если нужно.

## План действий (Step-by-Step)

1.  **HOTFIX:** Включить `--proxy-headers` в systemd и перезапустить сервис. Проверить, исчезла ли проблема с сессиями.
2.  **Refactor:** Разнести `main.py` на роутеры (`routers/`).
3.  **UX:** Добавить обработчик исключения `HTTPException 401`, который делает `RedirectResponse("/login")`.
4.  **Verification:** Проверить работу всех кнопок (Add, Delete, Edit) и графиков.

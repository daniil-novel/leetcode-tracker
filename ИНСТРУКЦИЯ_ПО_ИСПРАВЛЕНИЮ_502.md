# Инструкция по исправлению ошибки 502 Bad Gateway

## Проблема
После удаления кода из проекта появилась ошибка "502 Bad Gateway nginx/1.18.0 (Ubuntu)".

## Быстрое решение

### Шаг 1: Подключитесь к серверу
```bash
ssh root@novel-cloudtech.com
```

### Шаг 2: Запустите скрипт автоматического исправления
```bash
cd /root/leetcode_tracker_uv
chmod +x fix_502_error.sh
./fix_502_error.sh
```

Этот скрипт автоматически:
1. Остановит сервис
2. Синхронизирует все зависимости Python
3. Проверит наличие .env файла
4. Проверит сборку фронтенда
5. Протестирует запуск приложения
6. Перезапустит сервис

### Шаг 3: Проверьте результат
Откройте в браузере: https://novel-cloudtech.com:7443

## Если не помогло - диагностика

### Запустите диагностический скрипт:
```bash
cd /root/leetcode_tracker_uv
chmod +x diagnose_502.sh
./diagnose_502.sh
```

Скрипт покажет:
- Статус сервиса
- Логи приложения
- Слушает ли порт 8000
- Статус nginx
- Наличие .env файла
- Наличие сборки фронтенда
- Установленные зависимости

## Наиболее вероятные причины

### 1. Отсутствуют зависимости Python
**Симптом:** В логах ошибки типа "ModuleNotFoundError"

**Решение:**
```bash
cd /root/leetcode_tracker_uv
uv sync
systemctl restart leetcode-tracker
```

### 2. Приложение не запущено
**Проверка:**
```bash
systemctl status leetcode-tracker
```

**Решение:**
```bash
systemctl restart leetcode-tracker
```

### 3. Отсутствует .env файл
**Проверка:**
```bash
cat /root/leetcode_tracker_uv/.env
```

**Необходимые переменные:**
- `SECRET_KEY` - для JWT токенов
- `GITHUB_CLIENT_ID` - для OAuth
- `GITHUB_CLIENT_SECRET` - для OAuth

### 4. Ошибки импорта
Вы могли удалить файл, который всё ещё импортируется где-то в коде.

**Проверка логов:**
```bash
journalctl -u leetcode-tracker -n 100 | grep -i "import\|error"
```

### 5. Отсутствует сборка фронтенда
**Проверка:**
```bash
ls -la /root/leetcode_tracker_uv/frontend/dist/
```

**Пересборка:**
```bash
cd /root/leetcode_tracker_uv/frontend
npm install
npm run build
```

## Ручная диагностика

### Посмотреть точную ошибку:
```bash
cd /root/leetcode_tracker_uv
uv run uvicorn leetcode_tracker.main:app --host 127.0.0.1 --port 8001
```

Эта команда покажет точную ошибку, если приложение не запускается.

### Посмотреть логи сервиса:
```bash
journalctl -u leetcode-tracker -n 50 --no-pager
```

### Проверить, что было удалено:
```bash
cd /root/leetcode_tracker_uv
git status
git diff HEAD
```

## Восстановление удалённого кода

### Если не уверены, что удалили:

**Посмотреть последние изменения:**
```bash
git log --oneline -10
git show HEAD
```

**Посмотреть разницу:**
```bash
git diff HEAD~1 HEAD
```

**Откатить всё к последнему коммиту:**
```bash
git reset --hard HEAD
```

**Восстановить конкретный файл:**
```bash
git checkout HEAD -- <имя_файла>
```

## Типичные ошибки и решения

### "ModuleNotFoundError: No module named 'X'"
**Причина:** Удалён модуль, который всё ещё импортируется.

**Решение:** Либо восстановите модуль, либо удалите импорт.

### "ValidationError" от Pydantic
**Причина:** Отсутствуют обязательные переменные в .env

**Решение:** Добавьте недостающие переменные в .env файл.

### "No such file or directory: 'frontend/dist'"
**Причина:** Фронтенд не собран.

**Решение:**
```bash
cd /root/leetcode_tracker_uv/frontend
npm run build
```

### Порт 8000 не слушает
**Причина:** Приложение не запустилось.

**Решение:** Проверьте логи: `journalctl -u leetcode-tracker -n 100`

## Пошаговая инструкция

1. **Подключитесь к серверу:**
   ```bash
   ssh root@novel-cloudtech.com
   ```

2. **Запустите скрипт исправления:**
   ```bash
   cd /root/leetcode_tracker_uv
   chmod +x fix_502_error.sh
   ./fix_502_error.sh
   ```

3. **Если не помогло, запустите диагностику:**
   ```bash
   ./diagnose_502.sh
   ```

4. **Посмотрите логи для точной ошибки:**
   ```bash
   journalctl -u leetcode-tracker -n 100
   ```

5. **Попробуйте запустить вручную:**
   ```bash
   uv run uvicorn leetcode_tracker.main:app --host 127.0.0.1 --port 8001
   ```

6. **Если нужно, откатите изменения:**
   ```bash
   git reset --hard HEAD
   systemctl restart leetcode-tracker
   ```

## Профилактика на будущее

Перед удалением кода:

1. **Создайте коммит:**
   ```bash
   git add .
   git commit -m "Перед очисткой кода"
   ```

2. **Протестируйте локально:**
   ```bash
   uv run uvicorn leetcode_tracker.main:app --reload
   ```

3. **Проверьте неиспользуемые импорты:**
   ```bash
   ruff check --select F401
   ```

## Всё ещё не работает?

Запустите полную диагностику и сохраните вывод:
```bash
cd /root/leetcode_tracker_uv
./diagnose_502.sh > diagnostic_output.txt 2>&1
cat diagnostic_output.txt
```

Отправьте мне содержимое файла `diagnostic_output.txt` для дальнейшей помощи.

{% extends "base.html" %}
{% block content %}

<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–ª—å—é –º–µ—Å—è—Ü–∞ -->
<section class="goal-section">
    <div class="goal-header">
        <h2>
            <span class="section-icon">üéØ</span>
            –¶–µ–ª—å –Ω–∞ –º–µ—Å—è—Ü
        </h2>
        <div class="goal-controls">
            <div class="goal-edit">
                <input type="number" id="goalInput" min="1" value="100" class="goal-input">
                <span class="goal-label">XP</span>
                <button id="setGoalBtn" class="goal-btn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <button id="clearAllBtn" class="clear-all-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏</button>
        </div>
    </div>
</section>

<!-- –ú–µ—Ç—Ä–∏–∫–∏ KPI -->
<section class="metrics-section">
    <div class="metric-card gradient-blue">
        <div class="metric-icon">üìä</div>
        <div class="metric-content">
            <div class="metric-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
            <div class="metric-value" id="progressPercent">0%</div>
            <div class="metric-subtitle"><span id="currentXP">0</span> / <span id="targetXP">100</span> XP</div>
        </div>
    </div>
    <div class="metric-card gradient-green">
        <div class="metric-icon">‚úÖ</div>
        <div class="metric-content">
            <div class="metric-label">–†–µ—à–µ–Ω–æ –∑–∞–¥–∞—á</div>
            <div class="metric-value" id="totalTasks">0</div>
            <div class="metric-subtitle">–≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</div>
        </div>
    </div>
    <div class="metric-card gradient-purple">
        <div class="metric-icon">üìö</div>
        <div class="metric-content">
            <div class="metric-label">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</div>
            <div class="metric-value metric-distribution">
                <span class="diff-indicator easy" id="easyCount">0</span>
                <span class="diff-indicator medium" id="mediumCount">0</span>
                <span class="diff-indicator hard" id="hardCount">0</span>
            </div>
            <div class="metric-subtitle">Easy / Medium / Hard</div>
        </div>
    </div>
    <div class="metric-card gradient-orange">
        <div class="metric-icon">üî•</div>
        <div class="metric-content">
            <div class="metric-label">–¢–µ–∫—É—â–∏–π Streak</div>
            <div class="metric-value" id="currentStreak">0</div>
            <div class="metric-subtitle">–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
        </div>
    </div>
</section>

<!-- –ë–æ–ª—å—à–æ–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å -->
<section class="calendar-section">
    <div class="calendar-header">
        <h2>
            <span class="section-icon">üìÖ</span>
            –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        </h2>
        <div class="calendar-nav">
            <button class="nav-btn" id="prevMonthBtn">‚óÄ</button>
            <span class="calendar-month-title" id="calendarMonthTitle">–ù–æ—è–±—Ä—å 2025</span>
            <button class="nav-btn" id="nextMonthBtn">‚ñ∂</button>
        </div>
    </div>
    <div class="calendar-container">
        <div class="calendar-weekdays">
            <div class="weekday">–ü–Ω</div>
            <div class="weekday">–í—Ç</div>
            <div class="weekday">–°—Ä</div>
            <div class="weekday">–ß—Ç</div>
            <div class="weekday">–ü—Ç</div>
            <div class="weekday">–°–±</div>
            <div class="weekday">–í—Å</div>
        </div>
        <div class="calendar-grid" id="calendarGrid">
            <!-- –î–Ω–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
        </div>
    </div>
</section>

<!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
<section class="form-section">
    <h2>
        <span class="section-icon">‚ûï</span>
        –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
    </h2>
    <form method="post" action="/add" class="task-form">
        <label>
            <span class="label-text">–î–∞—Ç–∞</span>
            <input type="date" name="date" required value="{{ today }}">
        </label>

        <label>
            <span class="label-text">–°–ª–æ–∂–Ω–æ—Å—Ç—å</span>
            <select name="difficulty" id="difficultySelect">
                <option value="Easy">Easy (1 XP)</option>
                <option value="Medium" selected>Medium (3 XP)</option>
                <option value="Hard">Hard (5 XP)</option>
            </select>
        </label>

        <label>
            <span class="label-text">XP</span>
            <input type="number" name="points" id="pointsInput" value="3" min="1" required>
        </label>

        <label>
            <span class="label-text">–í—Ä–µ–º—è (–º–∏–Ω)</span>
            <input type="number" name="time_spent" id="timeSpentInput" placeholder="–°–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏?" min="1">
        </label>

        <label>
            <span class="label-text">ID –∑–∞–¥–∞—á–∏</span>
            <input type="text" name="problem_id" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 209">
        </label>

        <label class="fullwidth">
            <span class="label-text">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
            <input type="text" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
        </label>

        <label class="fullwidth">
            <span class="label-text">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span>
            <textarea name="notes" rows="3" placeholder="–ß—Ç–æ –±—ã–ª–æ —Å–ª–æ–∂–Ω—ã–º? –ß—Ç–æ –≤—ã—É—á–∏–ª? –ö–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª?"></textarea>
        </label>

        <button type="submit" class="submit-btn">
            <span class="btn-icon">üíæ</span>
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É
        </button>
    </form>
</section>

<!-- –ì—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
<section class="charts">
    <h2>
        <span class="section-icon">üìà</span>
        –ì—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        <button id="importCsvBtn" class="import-btn">üì• –ò–º–ø–æ—Ä—Ç –∏–∑ CSV</button>
    </h2>
    <div class="chart-grid">
        <div class="chart-card" data-chart="monthGoal">
            <h3>
                –ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–∏ –º–µ—Å—è—Ü–∞
                <button class="expand-btn" onclick="expandChart('monthGoal')">‚õ∂</button>
            </h3>
            <canvas id="monthGoalChart"></canvas>
        </div>
        <div class="chart-card" data-chart="difficulty">
            <h3>
                –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                <button class="expand-btn" onclick="expandChart('difficulty')">‚õ∂</button>
            </h3>
            <canvas id="difficultyChart"></canvas>
        </div>
        <div class="chart-card" data-chart="tasksPerDay">
            <h3>
                –ó–∞–¥–∞—á–∏ –≤ –¥–µ–Ω—å
                <button class="expand-btn" onclick="expandChart('tasksPerDay')">‚õ∂</button>
            </h3>
            <canvas id="tasksPerDay"></canvas>
        </div>
        <div class="chart-card" data-chart="xpPerDay">
            <h3>
                XP –≤ –¥–µ–Ω—å
                <button class="expand-btn" onclick="expandChart('xpPerDay')">‚õ∂</button>
            </h3>
            <canvas id="xpPerDay"></canvas>
        </div>
        <div class="chart-card" data-chart="xpCumulative">
            <h3>
                –ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π XP
                <button class="expand-btn" onclick="expandChart('xpCumulative')">‚õ∂</button>
            </h3>
            <canvas id="xpCumulative"></canvas>
        </div>
        <div class="chart-card" data-chart="streak">
            <h3>
                –ò—Å—Ç–æ—Ä–∏—è Streak
                <button class="expand-btn" onclick="expandChart('streak')">‚õ∂</button>
            </h3>
            <canvas id="streakChart"></canvas>
        </div>
        <div class="chart-card" data-chart="timePerTask">
            <h3>
                –í—Ä–µ–º—è –Ω–∞ –∑–∞–¥–∞—á—É
                <button class="expand-btn" onclick="expandChart('timePerTask')">‚õ∂</button>
            </h3>
            <canvas id="timePerTaskChart"></canvas>
        </div>
        <div class="chart-card" data-chart="avgTimeByDifficulty">
            <h3>
                –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                <button class="expand-btn" onclick="expandChart('avgTimeByDifficulty')">‚õ∂</button>
            </h3>
            <canvas id="avgTimeByDifficultyChart"></canvas>
        </div>
    </div>
</section>

<!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–¥–∞—á -->
<section class="table-section">
    <h2>
        <span class="section-icon">üìù</span>
        –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–¥–∞—á–∏
        <span class="task-counter" id="taskCounter">0 –∑–∞–¥–∞—á</span>
    </h2>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>ID</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
                    <th>XP</th>
                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                </tr>
            </thead>
            <tbody>
                {% for t in tasks %}
                <tr class="difficulty-{{ t.difficulty.lower() }}">
                    <td class="date-cell">{{ t.date }}</td>
                    <td class="id-cell">
                        {% if t.problem_id %}
                        <a href="https://leetcode.com/problems/{{ t.problem_id }}" target="_blank" class="problem-link">
                            {{ t.problem_id }}
                        </a>
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </td>
                    <td class="title-cell">{{ t.title or "‚Äî" }}</td>
                    <td class="difficulty-cell">
                        <span class="difficulty-badge {{ t.difficulty.lower() }}">
                            {{ t.difficulty }}
                        </span>
                    </td>
                    <td class="xp-cell">
                        <span class="xp-badge">{{ t.points }} XP</span>
                    </td>
                    <td class="notes-cell">{{ t.notes or "‚Äî" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
<div id="chartModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeChartModal()">&times;</span>
        <h2 id="modalChartTitle">–ì—Ä–∞—Ñ–∏–∫</h2>
        <canvas id="modalChart"></canvas>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –¥–Ω—è -->
<div id="dayModal" class="modal">
    <div class="modal-content day-modal-content">
        <span class="close-modal" onclick="closeDayModal()">&times;</span>
        <h2 id="dayModalTitle">–î–µ—Ç–∞–ª–∏ –¥–Ω—è</h2>
        <div id="dayModalContent"></div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ CSV -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeImportModal()">&times;</span>
        <h2>–ò–º–ø–æ—Ä—Ç –∑–∞–¥–∞—á –∏–∑ CSV</h2>
        <form id="uploadCsvForm" class="edit-form">
            <label class="fullwidth">
                <span class="label-text">–í—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª</span>
                <input type="file" id="csvFile" accept=".csv" required>
            </label>
            <div class="modal-buttons">
                <button type="submit" class="submit-btn">
                    <span class="btn-icon">üì•</span>
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å
                </button>
                <button type="button" class="cancel-btn" onclick="closeImportModal()">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/–¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
<div id="editTaskModal" class="modal">
    <div class="modal-content edit-task-modal">
        <span class="close-modal" onclick="closeEditModal()">&times;</span>
        <h2 id="editModalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</h2>
        <form id="editTaskForm" class="edit-form">
            <input type="hidden" id="editTaskId">
            <input type="hidden" id="editTaskDate">
            
            <label>
                <span class="label-text">–î–∞—Ç–∞</span>
                <input type="date" id="editDate" required>
            </label>

            <label>
                <span class="label-text">–°–ª–æ–∂–Ω–æ—Å—Ç—å</span>
                <select id="editDifficulty">
                    <option value="Easy">Easy (1 XP)</option>
                    <option value="Medium">Medium (3 XP)</option>
                    <option value="Hard">Hard (5 XP)</option>
                </select>
            </label>

            <label>
                <span class="label-text">XP</span>
                <input type="number" id="editPoints" min="1" required>
            </label>

            <label>
                <span class="label-text">ID –∑–∞–¥–∞—á–∏</span>
                <input type="text" id="editProblemId" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 209">
            </label>

            <label class="fullwidth">
                <span class="label-text">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
                <input type="text" id="editTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
            </label>

            <label class="fullwidth">
                <span class="label-text">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span>
                <textarea id="editNotes" rows="3" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
            </label>

            <div class="modal-buttons">
                <button type="submit" class="submit-btn">
                    <span class="btn-icon">üíæ</span>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button type="button" class="cancel-btn" onclick="closeEditModal()">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentYear = 2025;
let currentMonth = 11;
let monthStats = null;
let allCharts = {};

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ XP –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
document.getElementById('difficultySelect').addEventListener('change', function() {
    const points = {
        'Easy': 1,
        'Medium': 3,
        'Hard': 5
    };
    document.getElementById('pointsInput').value = points[this.value] || 3;
});

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ—Å—è—á–Ω–æ–π —Ü–µ–ª–∏
document.getElementById('setGoalBtn').addEventListener('click', async () => {
    const targetXP = parseInt(document.getElementById('goalInput').value);
    
    const response = await fetch('/api/month/goal', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            year: currentYear,
            month: currentMonth,
            target_xp: targetXP
        })
    });
    
    if (response.ok) {
        await loadMonthStats(currentYear, currentMonth);
        alert('–¶–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
    }
});

// –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV
document.getElementById('importCsvBtn').addEventListener('click', () => {
    document.getElementById('importModal').style.display = 'flex';
});

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–º–ø–æ—Ä—Ç–∞
function closeImportModal() {
    document.getElementById('importModal').style.display = 'none';
    document.getElementById('csvFile').value = '';
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV —Ñ–∞–π–ª–∞
document.getElementById('uploadCsvForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/import/csv', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            closeImportModal();
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message);
    }
});


// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ—Å—è—Ü–∞
async function loadMonthStats(year, month) {
    const response = await fetch(`/api/month/stats/${year}/${month}`);
    monthStats = await response.json();
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
    document.getElementById('progressPercent').textContent = Math.round(monthStats.progress_percent) + '%';
    document.getElementById('currentXP').textContent = monthStats.current_xp;
    document.getElementById('targetXP').textContent = monthStats.target_xp;
    document.getElementById('totalTasks').textContent = monthStats.total_tasks;
    document.getElementById('easyCount').textContent = monthStats.easy_count;
    document.getElementById('mediumCount').textContent = monthStats.medium_count;
    document.getElementById('hardCount').textContent = monthStats.hard_count;
    document.getElementById('goalInput').value = monthStats.target_xp;
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    renderCalendar(monthStats);
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
function renderCalendar(stats) {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    
    const monthNames = ['', '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                        '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
    document.getElementById('calendarMonthTitle').textContent = 
        `${monthNames[stats.month]} ${stats.year}`;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞ (0=–ü–Ω, 6=–í—Å)
    const firstDayOfMonth = new Date(stats.year, stats.month - 1, 1);
    let startDayOfWeek = firstDayOfMonth.getDay() - 1;
    if (startDayOfWeek < 0) startDayOfWeek = 6;
    
    // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
    for (let i = 0; i < startDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day empty';
        grid.appendChild(emptyDay);
    }
    
    // –î–Ω–∏ –º–µ—Å—è—Ü–∞
    stats.calendar_days.forEach(day => {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        
        if (day.tasks_count > 0) {
            dayEl.classList.add('has-tasks');
            dayEl.style.setProperty('--intensity', Math.min(day.xp_sum / 10, 1));
        }
        
        const today = new Date().toISOString().split('T')[0];
        if (day.date === today) {
            dayEl.classList.add('today');
        }
        
        dayEl.innerHTML = `
            <div class="day-number">${new Date(day.date).getDate()}</div>
            ${day.tasks_count > 0 ? `
                <div class="day-stats">
                    <div class="day-xp">${day.xp_sum} XP</div>
                    <div class="day-tasks">
                        ${day.easy_count > 0 ? `<span class="task-dot easy" title="${day.easy_count} Easy"></span>` : ''}
                        ${day.medium_count > 0 ? `<span class="task-dot medium" title="${day.medium_count} Medium"></span>` : ''}
                        ${day.hard_count > 0 ? `<span class="task-dot hard" title="${day.hard_count} Hard"></span>` : ''}
                    </div>
                </div>
            ` : ''}
        `;
        
        if (day.tasks_count > 0) {
            dayEl.onclick = () => showDayDetailsWithActions(day);
        }
        
        grid.appendChild(dayEl);
    });
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –¥–Ω—è
function showDayDetails(day) {
    const modal = document.getElementById('dayModal');
    const title = document.getElementById('dayModalTitle');
    const content = document.getElementById('dayModalContent');
    
    const dayDate = new Date(day.date);
    const monthNames = ['', '–Ø–Ω–≤–∞—Ä—è', '–§–µ–≤—Ä–∞–ª—è', '–ú–∞—Ä—Ç–∞', '–ê–ø—Ä–µ–ª—è', '–ú–∞—è', '–ò—é–Ω—è', 
                        '–ò—é–ª—è', '–ê–≤–≥—É—Å—Ç–∞', '–°–µ–Ω—Ç—è–±—Ä—è', '–û–∫—Ç—è–±—Ä—è', '–ù–æ—è–±—Ä—è', '–î–µ–∫–∞–±—Ä—è'];
    
    title.textContent = `${dayDate.getDate()} ${monthNames[dayDate.getMonth() + 1]} ${dayDate.getFullYear()}`;
    
    content.innerHTML = `
        <div class="day-summary">
            <div class="summary-item"><strong>–í—Å–µ–≥–æ –∑–∞–¥–∞—á:</strong> ${day.tasks_count}</div>
            <div class="summary-item"><strong>XP –∑–∞ –¥–µ–Ω—å:</strong> ${day.xp_sum}</div>
            <div class="summary-item">
                <strong>–ü–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</strong>
                ${day.easy_count > 0 ? `<span class="difficulty-badge easy">Easy: ${day.easy_count}</span>` : ''}
                ${day.medium_count > 0 ? `<span class="difficulty-badge medium">Medium: ${day.medium_count}</span>` : ''}
                ${day.hard_count > 0 ? `<span class="difficulty-badge hard">Hard: ${day.hard_count}</span>` : ''}
            </div>
        </div>
        <div class="day-tasks-list">
            <h3>–†–µ—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:</h3>
            ${day.tasks.map(task => `
                <div class="task-item difficulty-${task.difficulty.lower()}">
                    <div class="task-header">
                        <span class="difficulty-badge ${task.difficulty.toLowerCase()}">${task.difficulty}</span>
                        <span class="xp-badge">${task.points} XP</span>
                    </div>
                    ${task.problem_id ? `<div class="task-id">–ó–∞–¥–∞—á–∞ #${task.problem_id}</div>` : ''}
                    ${task.title ? `<div class="task-title">${task.title}</div>` : ''}
                    ${task.notes ? `<div class="task-notes">${task.notes}</div>` : ''}
                </div>
            `).join('')}
        </div>
    `;
    
    modal.style.display = 'flex';
}

function closeDayModal() {
    document.getElementById('dayModal').style.display = 'none';
}

// –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
let modalChartInstance = null;

function expandChart(chartType) {
    const modal = document.getElementById('chartModal');
    const canvas = document.getElementById('modalChart');
    const title = document.getElementById('modalChartTitle');
    
    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫
    if (modalChartInstance) {
        modalChartInstance.destroy();
    }
    
    // –ö–æ–ø–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
    const sourceChart = allCharts[chartType];
    if (!sourceChart) return;
    
    const titles = {
        'monthGoal': '–ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–∏ –º–µ—Å—è—Ü–∞',
        'difficulty': '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏',
        'tasksPerDay': '–ó–∞–¥–∞—á–∏ –≤ –¥–µ–Ω—å',
        'xpPerDay': 'XP –≤ –¥–µ–Ω—å',
        'xpCumulative': '–ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π XP',
        'streak': '–ò—Å—Ç–æ—Ä–∏—è Streak'
    };
    
    title.textContent = titles[chartType] || '–ì—Ä–∞—Ñ–∏–∫';
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    modalChartInstance = new Chart(canvas, {
        type: sourceChart.config.type,
        data: JSON.parse(JSON.stringify(sourceChart.config.data)),
        options: {
            ...sourceChart.config.options,
            maintainAspectRatio: true,
            aspectRatio: 2
        }
    });
    
    modal.style.display = 'flex';
}

function closeChartModal() {
    document.getElementById('chartModal').style.display = 'none';
    if (modalChartInstance) {
        modalChartInstance.destroy();
        modalChartInstance = null;
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
window.onclick = function(event) {
    const chartModal = document.getElementById('chartModal');
    const dayModal = document.getElementById('dayModal');
    if (event.target === chartModal) {
        closeChartModal();
    }
    if (event.target === dayModal) {
        closeDayModal();
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
async function loadStats() {
    const res = await fetch('/api/stats/daily');
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
        return;
    }

    const labels = data.map(d => d.date);
    const tasks = data.map(d => d.tasks_count);
    const xp = data.map(d => d.xp_sum);
    const xpCum = data.map(d => d.xp_cumulative);
    const streak = data.map(d => d.streak);

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ streak –º–µ—Ç—Ä–∏–∫–∏
    const currentStreak = streak[streak.length - 1] || 0;
    document.getElementById('currentStreak').textContent = currentStreak;

    // –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
    Chart.defaults.color = '#9ca3af';
    Chart.defaults.borderColor = '#27272f';
    Chart.defaults.font.family = 'system-ui, -apple-system, sans-serif';

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    const difficultyData = await fetch('/api/tasks').then(r => r.json()).catch(() => []);
    const easyCount = difficultyData.filter(t => t.difficulty === 'Easy').length;
    const mediumCount = difficultyData.filter(t => t.difficulty === 'Medium').length;
    const hardCount = difficultyData.filter(t => t.difficulty === 'Hard').length;

    // –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫ —Ü–µ–ª–∏ (–±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ—Å—è—Ü–∞)
    allCharts.monthGoal = new Chart(document.getElementById('monthGoalChart'), {
        type: 'doughnut',
        data: {
            labels: ['–í—ã–ø–æ–ª–Ω–µ–Ω–æ', '–û—Å—Ç–∞–ª–æ—Å—å'],
            datasets: [{
                data: [0, 100],
                backgroundColor: [
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(100, 116, 139, 0.3)'
                ],
                borderColor: [
                    'rgba(34, 197, 94, 1)',
                    'rgba(100, 116, 139, 0.5)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        font: { size: 12 }
                    }
                }
            }
        }
    });

    // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    allCharts.difficulty = new Chart(document.getElementById('difficultyChart'), {
        type: 'pie',
        data: {
            labels: ['Easy', 'Medium', 'Hard'],
            datasets: [{
                data: [easyCount, mediumCount, hardCount],
                backgroundColor: [
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(251, 191, 36, 0.8)',
                    'rgba(239, 68, 68, 0.8)'
                ],
                borderColor: [
                    'rgba(34, 197, 94, 1)',
                    'rgba(251, 191, 36, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        font: { size: 12 }
                    }
                }
            }
        }
    });

    // –ì—Ä–∞—Ñ–∏–∫ –∑–∞–¥–∞—á –≤ –¥–µ–Ω—å
    allCharts.tasksPerDay = new Chart(document.getElementById('tasksPerDay'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '–ó–∞–¥–∞—á –≤ –¥–µ–Ω—å',
                data: tasks,
                backgroundColor: 'rgba(99, 102, 241, 0.6)',
                borderColor: 'rgba(99, 102, 241, 1)',
                borderWidth: 1,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });

    // –ì—Ä–∞—Ñ–∏–∫ XP –≤ –¥–µ–Ω—å
    allCharts.xpPerDay = new Chart(document.getElementById('xpPerDay'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'XP –≤ –¥–µ–Ω—å',
                data: xp,
                backgroundColor: 'rgba(34, 197, 94, 0.6)',
                borderColor: 'rgba(34, 197, 94, 1)',
                borderWidth: 1,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // –ì—Ä–∞—Ñ–∏–∫ –∫—É–º—É–ª—è—Ç–∏–≤–Ω–æ–≥–æ XP
    allCharts.xpCumulative = new Chart(document.getElementById('xpCumulative'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π XP',
                data: xpCum,
                borderColor: 'rgba(168, 85, 247, 1)',
                backgroundColor: 'rgba(168, 85, 247, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // –ì—Ä–∞—Ñ–∏–∫ Streak
    allCharts.streak = new Chart(document.getElementById('streakChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Streak (–¥–Ω–∏)',
                data: streak,
                borderColor: 'rgba(251, 191, 36, 1)',
                backgroundColor: 'rgba(251, 191, 36, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
    await loadMonthStats(currentYear, currentMonth);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    if (monthStats) {
        const remaining = Math.max(0, monthStats.target_xp - monthStats.current_xp);
        allCharts.monthGoal.data.datasets[0].data = [monthStats.current_xp, remaining];
        allCharts.monthGoal.update();
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—Ä–µ–º–µ–Ω–∏
    const timeStats = await fetch('/api/stats/time').then(r => r.json()).catch(() => null);
    
    if (timeStats && timeStats.tasks.length > 0) {
        // –ì—Ä–∞—Ñ–∏–∫ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∑–∞–¥–∞—á—É —Å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ–º –∑–∞–¥–∞—á
        const timeLabels = timeStats.tasks.map(t => t.title.substring(0, 20) + (t.title.length > 20 ? '...' : ''));
        const timeData = timeStats.tasks.map(t => t.time_spent);
        const timeColors = timeStats.tasks.map(t => {
            switch(t.difficulty) {
                case 'Easy': return 'rgba(34, 197, 94, 0.6)';
                case 'Medium': return 'rgba(251, 191, 36, 0.6)';
                case 'Hard': return 'rgba(239, 68, 68, 0.6)';
                default: return 'rgba(99, 102, 241, 0.6)';
            }
        });

        allCharts.timePerTask = new Chart(document.getElementById('timePerTaskChart'), {
            type: 'bar',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: '–í—Ä–µ–º—è (–º–∏–Ω)',
                    data: timeData,
                    backgroundColor: timeColors,
                    borderColor: timeColors.map(c => c.replace('0.6', '1')),
                    borderWidth: 1,
                    borderRadius: 6
                }, {
                    label: '–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è',
                    data: Array(timeData.length).fill(timeStats.average_time),
                    type: 'line',
                    borderColor: 'rgba(255, 99, 132, 0.8)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            padding: 10,
                            usePointStyle: true,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const index = context[0].dataIndex;
                                return timeStats.tasks[index].title;
                            },
                            label: function(context) {
                                if (context.dataset.label === '–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è') {
                                    return `–°—Ä–µ–¥–Ω–µ–µ: ${timeStats.average_time.toFixed(1)} –º–∏–Ω`;
                                }
                                return `–í—Ä–µ–º—è: ${context.parsed.y} –º–∏–Ω`;
                            },
                            afterLabel: function(context) {
                                if (context.dataset.label === '–í—Ä–µ–º—è (–º–∏–Ω)') {
                                    const index = context.dataIndex;
                                    const task = timeStats.tasks[index];
                                    return [`–°–ª–æ–∂–Ω–æ—Å—Ç—å: ${task.difficulty}`, `–î–∞—Ç–∞: ${task.date}`];
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '–ú–∏–Ω—É—Ç—ã'
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            font: { size: 10 }
                        }
                    }
                }
            }
        });

        // –ì—Ä–∞—Ñ–∏–∫ —Å—Ä–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        allCharts.avgTimeByDifficulty = new Chart(document.getElementById('avgTimeByDifficultyChart'), {
            type: 'bar',
            data: {
                labels: ['Easy', 'Medium', 'Hard'],
                datasets: [{
                    label: '–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è (–º–∏–Ω)',
                    data: [
                        timeStats.avg_by_difficulty.Easy,
                        timeStats.avg_by_difficulty.Medium,
                        timeStats.avg_by_difficulty.Hard
                    ],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.6)',
                        'rgba(251, 191, 36, 0.6)',
                        'rgba(239, 68, 68, 0.6)'
                    ],
                    borderColor: [
                        'rgba(34, 197, 94, 1)',
                        'rgba(251, 191, 36, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: ${context.parsed.y.toFixed(1)} –º–∏–Ω`;
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '–ú–∏–Ω—É—Ç—ã'
                        }
                    }
                }
            }
        });
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        const noDataChart = {
            type: 'bar',
            data: {
                labels: ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
                datasets: [{
                    label: '–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç',
                    data: [0],
                    backgroundColor: 'rgba(100, 116, 139, 0.3)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                }
            }
        };
        
        allCharts.timePerTask = new Chart(document.getElementById('timePerTaskChart'), noDataChart);
        allCharts.avgTimeByDifficulty = new Chart(document.getElementById('avgTimeByDifficultyChart'), noDataChart);
    }
}

// –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º
document.getElementById('prevMonthBtn').addEventListener('click', () => {
    currentMonth--;
    if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
    }
    loadMonthStats(currentYear, currentMonth);
});

document.getElementById('nextMonthBtn').addEventListener('click', () => {
    currentMonth++;
    if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
    }
    loadMonthStats(currentYear, currentMonth);
});

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–ª–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
document.getElementById('setGoalBtn').addEventListener('click', async () => {
    const targetXP = parseInt(document.getElementById('goalInput').value);
    
    const response = await fetch('/api/month/goal', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            year: currentYear,
            month: currentMonth,
            target_xp: targetXP
        })
    });
    
    if (response.ok) {
        await loadMonthStats(currentYear, currentMonth);
        alert('–¶–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
    }
});

// –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∑–∞–¥–∞—á
document.getElementById('clearAllBtn').addEventListener('click', async () => {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞–¥–∞—á–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;
    
    const response = await fetch('/api/tasks/clear', {method: 'DELETE'});
    const result = await response.json();
    
    alert(result.message);
    location.reload();
});

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è showDayDetails —Å –∫–Ω–æ–ø–∫–∞–º–∏
function showDayDetailsWithActions(day) {
    const modal = document.getElementById('dayModal');
    const title = document.getElementById('dayModalTitle');
    const content = document.getElementById('dayModalContent');
    
    const dayDate = new Date(day.date);
    const monthNames = ['', '–Ø–Ω–≤–∞—Ä—è', '–§–µ–≤—Ä–∞–ª—è', '–ú–∞—Ä—Ç–∞', '–ê–ø—Ä–µ–ª—è', '–ú–∞—è', '–ò—é–Ω—è', 
                        '–ò—é–ª—è', '–ê–≤–≥—É—Å—Ç–∞', '–°–µ–Ω—Ç—è–±—Ä—è', '–û–∫—Ç—è–±—Ä—è', '–ù–æ—è–±—Ä—è', '–î–µ–∫–∞–±—Ä—è'];
    
    title.textContent = `${dayDate.getDate()} ${monthNames[dayDate.getMonth() + 1]} ${dayDate.getFullYear()}`;
    
    content.innerHTML = `
        <div class="day-summary">
            <div class="summary-item"><strong>–í—Å–µ–≥–æ –∑–∞–¥–∞—á:</strong> ${day.tasks_count}</div>
            <div class="summary-item"><strong>XP –∑–∞ –¥–µ–Ω—å:</strong> ${day.xp_sum}</div>
            <div class="summary-item">
                <strong>–ü–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</strong>
                ${day.easy_count > 0 ? `<span class="difficulty-badge easy">Easy: ${day.easy_count}</span>` : ''}
                ${day.medium_count > 0 ? `<span class="difficulty-badge medium">Medium: ${day.medium_count}</span>` : ''}
                ${day.hard_count > 0 ? `<span class="difficulty-badge hard">Hard: ${day.hard_count}</span>` : ''}
            </div>
        </div>
        <div class="day-actions">
            <button class="action-btn add-btn" onclick="addTaskForDay('${day.date}')">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
            </button>
        </div>
        <div class="day-tasks-list">
            <h3>–†–µ—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:</h3>
            ${day.tasks.map(task => `
                <div class="task-item difficulty-${task.difficulty.toLowerCase()}">
                    <div class="task-header">
                        <div>
                            <span class="difficulty-badge ${task.difficulty.toLowerCase()}">${task.difficulty}</span>
                            <span class="xp-badge">${task.points} XP</span>
                        </div>
                        <div class="task-actions">
                            <button class="edit-task-btn" onclick="editTask(${task.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                            <button class="delete-task-btn" onclick="deleteTask(${task.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </div>
                    </div>
                    ${task.problem_id ? `<div class="task-id">–ó–∞–¥–∞—á–∞ #${task.problem_id}</div>` : ''}
                    ${task.title ? `<div class="task-title">${task.title}</div>` : ''}
                    ${task.notes ? `<div class="task-notes">${task.notes}</div>` : ''}
                </div>
            `).join('')}
        </div>
    `;
    
    modal.style.display = 'flex';
}

// –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –¥–Ω—è
function addTaskForDay(date) {
    closeDayModal();
    document.getElementById('editModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É';
    document.getElementById('editTaskId').value = '';
    document.getElementById('editDate').value = date;
    document.getElementById('editDifficulty').value = 'Medium';
    document.getElementById('editPoints').value = 3;
    document.getElementById('editProblemId').value = '';
    document.getElementById('editTitle').value = '';
    document.getElementById('editNotes').value = '';
    
    document.getElementById('editTaskModal').style.display = 'flex';
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É
async function editTask(taskId) {
    const response = await fetch('/api/tasks');
    const tasks = await response.json();
    const task = tasks.find(t => t.id === taskId);
    
    if (!task) return;
    
    closeDayModal();
    
    document.getElementById('editModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É';
    document.getElementById('editTaskId').value = task.id;
    document.getElementById('editDate').value = task.date;
    document.getElementById('editDifficulty').value = task.difficulty;
    document.getElementById('editPoints').value = task.points;
    document.getElementById('editProblemId').value = task.problem_id || '';
    document.getElementById('editTitle').value = task.title || '';
    document.getElementById('editNotes').value = task.notes || '';
    
    document.getElementById('editTaskModal').style.display = 'flex';
}

// –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É
async function deleteTask(taskId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) return;
    
    const response = await fetch(`/api/task/${taskId}`, {method: 'DELETE'});
    
    if (response.ok) {
        closeDayModal();
        await loadMonthStats(currentYear, currentMonth);
        await loadStats();
    }
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function closeEditModal() {
    document.getElementById('editTaskModal').style.display = 'none';
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
document.getElementById('editTaskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const taskId = document.getElementById('editTaskId').value;
    const taskData = {
        date: document.getElementById('editDate').value,
        difficulty: document.getElementById('editDifficulty').value,
        points: parseInt(document.getElementById('editPoints').value),
        problem_id: document.getElementById('editProblemId').value || null,
        title: document.getElementById('editTitle').value || null,
        notes: document.getElementById('editNotes').value || null,
        platform: 'leetcode'
    };
    
    if (taskId) {
        // –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–¥–∞—á—É
        const response = await fetch(`/api/task/${taskId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(taskData)
        });
        
        if (response.ok) {
            closeEditModal();
            await loadMonthStats(currentYear, currentMonth);
            await loadStats();
            alert('–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
        }
    } else {
        // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/add';
        
        for (const [key, value] of Object.entries(taskData)) {
            if (value !== null) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }
        }
        
        document.body.appendChild(form);
        form.submit();
    }
});

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ XP –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

 document.getElementById('editDifficulty').addEventListener('change', function() {
    const points = {
        'Easy': 1,
        'Medium': 3,
        'Hard': 5
    };
    document.getElementById('editPoints').value = points[this.value] || 3;
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
window.onclick = function(event) {
    const chartModal = document.getElementById('chartModal');
    const dayModal = document.getElementById('dayModal');
    const editModal = document.getElementById('editTaskModal');
    
    if (event.target === chartModal) {
        closeChartModal();
    }
    if (event.target === dayModal) {
        closeDayModal();
    }
    if (event.target === editModal) {
        closeEditModal();
    }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
loadStats();
</script>

{% endblock %}
